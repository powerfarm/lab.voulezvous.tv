perfeito ent√£o: time = voc√™ üí™üòÑ
vou te dar o caminho ‚Äúsolo-friendly‚Äù com o m√≠nimo pra rodar sem dor de cabe√ßa ‚Äî e j√° deixo os esqueletos prontos pra copiar/colar.

‚∏ª

0) Decis√£o de setup (solo)
	‚Ä¢	Dois Terraform roots separados:
	‚Ä¢	infra/cloudflare ‚Üí tudo do edge (Workers, R2, D1, KV, Queues, DNS, Tunnel).
	‚Ä¢	infra/lab ‚Üí o que roda nos Macs (Ollama pool, runner, launchd/cron, MinIO opcional, .env).
	‚Ä¢	State:
	‚Ä¢	Cloudflare: Terraform Cloud (free) ‚Äî te d√° lock e hist√≥rico.
	‚Ä¢	LAB: state local (simples e r√°pido).
(Se preferir, d√° pra usar Terraform Cloud nos dois.)

‚∏ª

1) Estrutura de pastas (copiar)

infra/
  cloudflare/
    backend.tf
    providers.tf
    main.tf
    variables.tf
    outputs.tf
    envs/
      staging.tfvars
      prod.tfvars
  lab/
    backend.tf
    providers.tf
    main.tf
    variables.tf
    outputs.tf
    vars/
      lab512.tfvars
      lab256.tfvars
      lab8gb.tfvars
    files/
      env.lab.tmpl
      launchd.ollama.plist.tmpl
      launchd.vvtv-runner.plist.tmpl
      scripts/
        install_tools.sh
        seed_models_ollama.sh
        start_minio.sh
        smoke_r2.sh
  modules/
    cloudflare/
      r2_bucket/
      d1_database/
      kv_namespace/
      queues/
      worker_api/
      dns/
      tunnel/
    lab/
      secrets_env/
      ollama_pool/
      minio_local/
      runner_job/

Obs.: usar m√≥dulos te protege de mudan√ßas de provider. Hoje s√≥ precisamos dos roots; voc√™ vai completando os m√≥dulos conforme avan√ßar.

‚∏ª

2) Root Cloudflare ‚Äî esqueleto ‚Äúsolo‚Äù

infra/cloudflare/backend.tf

terraform {
  cloud {
    organization = "voulezvous"
    workspaces { name = "vvtv-cloudflare-prod" }
  }
  required_version = ">= 1.6.0"
}

infra/cloudflare/providers.tf

terraform {
  required_providers {
    cloudflare = { source = "cloudflare/cloudflare", version = "~> 4.0" }
  }
}

provider "cloudflare" {
  api_token = var.cloudflare_api_token
}

infra/cloudflare/variables.tf

variable "cloudflare_api_token" { type = string }
variable "account_id"           { type = string }
variable "zone_id"              { type = string }
variable "r2_bucket_name"       { type = string  default = "vvtv-packs" }
variable "kv_namespaces"        { type = map(string) default = { "vvtv-config" = "v1" } }
variable "d1_db_name"           { type = string  default = "vvtv_db" }
variable "worker_name"          { type = string  default = "vvtv-api" }
variable "routes"               { type = list(string) default = [] } # ex: ["api.voulezvous.tv/*"]

infra/cloudflare/main.tf (chama m√≥dulos; recursos ocultos por tr√°s)

module "r2" {
  source      = "../modules/cloudflare/r2_bucket"
  account_id  = var.account_id
  name        = var.r2_bucket_name
}

module "kv" {
  source      = "../modules/cloudflare/kv_namespace"
  account_id  = var.account_id
  namespaces  = var.kv_namespaces
}

module "d1" {
  source      = "../modules/cloudflare/d1_database"
  account_id  = var.account_id
  name        = var.d1_db_name
}

module "worker_api" {
  source        = "../modules/cloudflare/worker_api"
  account_id    = var.account_id
  name          = var.worker_name
  routes        = var.routes
  bindings = {
    R2_PACKS = { type = "r2_bucket", value = module.r2.bucket_name }
    D1_DB    = { type = "d1",        value = module.d1.database_id }
    # KV/Queues conforme precisar
  }
}

module "dns" {
  source   = "../modules/cloudflare/dns"
  zone_id  = var.zone_id
  records  = [] # preenche quando quiser
}

infra/cloudflare/outputs.tf

output "worker_url" { value = module.worker_api.url }
output "r2_bucket"  { value = module.r2.bucket_name }
output "d1_name"    { value = var.d1_db_name }

infra/cloudflare/envs/prod.tfvars (exemplo)

cloudflare_api_token = "REDACTED"
account_id           = "xxxx"
zone_id              = "zzzz"
routes               = ["api.voulezvous.tv/*"]

Comandos (solo):

cd infra/cloudflare
terraform init
terraform apply -var-file=envs/prod.tfvars

PoD (Proof of Done):
	‚Ä¢	Sa√≠da mostra worker_url.
	‚Ä¢	curl https://<worker_url>/health ‚Üí { ok: true } (quando voc√™ subir o c√≥digo do Worker).
	‚Ä¢	Bucket R2 criado; D1 criado.

‚∏ª

3) Root LAB ‚Äî esqueleto ‚Äúsolo‚Äù

infra/lab/backend.tf

terraform {
  required_version = ">= 1.6.0"
  backend "local" {}
}

infra/lab/providers.tf

terraform {
  required_providers {
    local = { source = "hashicorp/local", version = "~> 2.5" }
    null  = { source = "hashicorp/null",  version = "~> 3.2" }
  }
}
provider "local" {}
provider "null"  {}

infra/lab/variables.tf

variable "lab_hostname"  { type = string  default = "LAB512" }
variable "lab_user"      { type = string  default = "dan" }
variable "ollama_models" { type = list(string) default = ["phi3:mini", "llama3.1:8b", "gemma2:9b"] }
variable "enable_minio"  { type = bool   default = false }

# secrets para gerar .env (N√ÉO commite)
variable "r2_access_key" { type = string, sensitive = true }
variable "r2_secret_key" { type = string, sensitive = true }
variable "r2_endpoint"   { type = string }
variable "r2_bucket"     { type = string }
variable "worker_url"    { type = string } # output do root cloudflare

infra/lab/main.tf

# 1) Render .env para /opt/vvtv/config/.env
resource "local_file" "env_lab" {
  filename = "${path.module}/render/.env.lab"
  content  = templatefile("${path.module}/files/env.lab.tmpl", {
    R2_ENDPOINT = var.r2_endpoint
    R2_BUCKET   = var.r2_bucket
    R2_ACCESS   = var.r2_access_key
    R2_SECRET   = var.r2_secret_key
    WORKER_URL  = var.worker_url
  })
}

# 2) Launchd plists (Ollama + Runner)
resource "local_file" "launchd_ollama" {
  filename = "${path.module}/render/launchd.ollama.plist"
  content  = templatefile("${path.module}/files/launchd.ollama.plist.tmpl", {
    USER = var.lab_user
  })
}

resource "local_file" "launchd_runner" {
  filename = "${path.module}/render/launchd.vvtv-runner.plist"
  content  = templatefile("${path.module}/files/launchd.vvtv-runner.plist.tmpl", {
    USER = var.lab_user
  })
}

# 3) Instaladores (brew/ollama/minio) + seed de modelos
resource "null_resource" "lab_bootstrap" {
  triggers = {
    env_hash   = filesha256(local_file.env_lab.filename)
    models     = join(",", var.ollama_models)
    enable_minio = tostring(var.enable_minio)
  }
  provisioner "local-exec" {
    interpreter = ["/bin/bash","-c"]
    command = <<-EOC
      set -e
      chmod +x ${path.module}/files/scripts/install_tools.sh
      chmod +x ${path.module}/files/scripts/seed_models_ollama.sh
      chmod +x ${path.module}/files/scripts/start_minio.sh

      sudo mkdir -p /opt/vvtv/config /opt/vvtv/logs
      sudo cp ${local_file.env_lab.filename} /opt/vvtv/config/.env
      sudo cp ${local_file.launchd_ollama.filename} /Library/LaunchDaemons/vvtv.ollama.plist
      sudo cp ${local_file.launchd_runner.filename} /Library/LaunchDaemons/vvtv.runner.plist

      sudo ${path.module}/files/scripts/install_tools.sh
      ${path.module}/files/scripts/seed_models_ollama.sh ${join(" ", var.ollama_models)}

      if [ "${var.enable_minio}" = "true" ]; then
        ${path.module}/files/scripts/start_minio.sh
      fi

      # Smoke: tenta listar packs no R2 via worker
      ${path.module}/files/scripts/smoke_r2.sh "${var.worker_url}"
    EOC
  }
}

infra/lab/vars/lab512.tfvars (exemplo)

lab_hostname  = "LAB512"
lab_user      = "dan"
ollama_models = ["phi3:mini", "llama3.1:8b", "gemma2:9b"]
enable_minio  = false

r2_endpoint   = "https://<accountid>.r2.cloudflarestorage.com"
r2_bucket     = "vvtv-packs"
r2_access_key = "REDACTED"
r2_secret_key = "REDACTED"
worker_url    = "https://vvtv-api.<your-zone>.workers.dev"

Comandos (solo):

cd infra/lab
terraform init
terraform apply -var-file=vars/lab512.tfvars

PoD (Proof of Done):
	‚Ä¢	brew services list mostra ollama rodando.
	‚Ä¢	launchctl list | grep vvtv lista os dois plists.
	‚Ä¢	tail -F /opt/vvtv/logs/*.log ‚Üí smoke ok.
	‚Ä¢	curl $WORKER_URL/health responde.

‚∏ª

4) Makefile ‚Äúum-comando-s√≥‚Äù (opcional)

Crie Makefile na raiz do repo:

CF_DIR=infra/cloudflare
LAB_DIR=infra/lab

.PHONY: cf-init cf-apply lab-init lab-apply
cf-init:
	cd $(CF_DIR) && terraform init

cf-apply:
	cd $(CF_DIR) && terraform apply -var-file=envs/prod.tfvars

lab-init:
	cd $(LAB_DIR) && terraform init

lab-apply:
	cd $(LAB_DIR) && terraform apply -var-file=vars/lab512.tfvars


‚∏ª

5) Em que etapa estamos (super claro)
	‚Ä¢	‚úÖ Provisionamento Cloud ‚Äî esqueleto pronto (Workers/R2/D1/KV/etc. via m√≥dulos).
	‚Ä¢	‚úÖ Provisionamento LAB ‚Äî esqueleto pronto (Ollama + runner + .env + launchd).
	‚Ä¢	‚è≥ L√≥gica de neg√≥cio (os Workers com endpoints) ‚Äî voc√™ pluga os scripts/servi√ßos que j√° temos (VVTV pack/plan API, etc.).
	‚Ä¢	‚è≥ SQL (D1) ‚Äî migrations/DDL do cat√°logo (podemos gerar com TDLN/UBL quando voc√™ quiser).

Se quiser, na pr√≥xima eu te mando:
	‚Ä¢	Templates dos m√≥dulos Cloudflare (R2, D1, Worker) com entradas/sa√≠das certinhas.
	‚Ä¢	Os templates dos launchd e scripts padr√£o (install/seed/smoke).

Mas j√° d√° pra come√ßar agora com esses roots. üöÄ